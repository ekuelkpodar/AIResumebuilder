generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CareerStage {
  STUDENT
  JUNIOR
  MID
  SENIOR
  EXECUTIVE
}

enum ResumeSectionType {
  HEADER
  SUMMARY
  EXPERIENCE
  EDUCATION
  SKILLS
  PROJECTS
  CERTIFICATIONS
  LANGUAGES
  INTERESTS
  CUSTOM
}

enum JobStatus {
  TO_APPLY
  APPLIED
  INTERVIEWING
  OFFER
  REJECTED
}

enum SubscriptionPlan {
  FREE
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  TRIALING
}

enum TenantType {
  INDIVIDUAL
  BOOTCAMP
  UNIVERSITY
  COMPANY
  AGENCY
}

enum TenantPlan {
  FREE
  PRO
  ENTERPRISE
}

enum TenantMemberRole {
  OWNER
  ADMIN
  COACH
  MEMBER
}

model User {
  id            String           @id @default(cuid())
  name          String?
  email         String?          @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          UserRole         @default(USER)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  accounts      Account[]
  sessions      Session[]
  profile       UserProfile?
  resumes       Resume[]
  jobApplications JobApplication[]
  coverLetters  CoverLetter[]
  subscription  Subscription?
  aiCalls       AICallLog[]
  personas      CareerPersona[]
  featureFlags  FeatureFlag[]
  comments      Comment[]
  organizations OrganizationMembership[]
  jobSources    JobSource[]
  jobLeads      JobLead[]
  interviewSessions UserInterviewSession[]
  stories       UserStory[]
  portfolios    Portfolio[]
  contacts      Contact[]
  outreachMessages OutreachMessage[]
  userPlugins   UserPluginConfig[]
  webhooks      WebhookEndpoint[]
  tenantMemberships TenantMembership[]
}

model Tenant {
  id        String     @id @default(cuid())
  name      String
  slug      String     @unique
  type      TenantType
  plan      TenantPlan @default(FREE)
  settings  Json       @default("{}")
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  memberships TenantMembership[]
  branding    TenantBranding?
}

model TenantMembership {
  id        String           @id @default(cuid())
  tenantId  String
  userId    String
  role      TenantMemberRole @default(MEMBER)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  tenant    Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TenantBranding {
  tenantId        String  @id
  logoUrl         String?
  primaryColor    String?
  secondaryColor  String?
  accentColor     String?
  fontFamily      String?
  domain          String?
  homeHeroTitle   String?
  homeHeroSubtitle String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
}

enum UserRole {
  USER
  ADMIN
}

model UserProfile {
  id          String      @id @default(cuid())
  userId      String      @unique
  careerStage CareerStage
  industry    String
  goal        String
  location    String?
  headline    String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  tenantId    String?

  user        User        @relation(fields: [userId], references: [id])
  tenant      Tenant?     @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Template {
  id           String   @id @default(cuid())
  name         String
  slug         String   @unique
  description  String
  category     String
  tags         String[]
  layoutConfig Json
  themeConfig  Json
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  resumes      Resume[]
}

model Resume {
  id            String         @id @default(cuid())
  userId        String
  tenantId      String?
  title         String
  templateId    String?
  personaId     String?
  layout        Json?
  data          Json
  language      String?        @default("en")
  atsScore      Int?
  lastAtsCheckAt DateTime?
  shareToken    String?        @unique
  isPublic      Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  user          User           @relation(fields: [userId], references: [id])
  template      Template?      @relation(fields: [templateId], references: [id])
  persona       CareerPersona? @relation(fields: [personaId], references: [id])
  sections      ResumeSection[]
  coverLetters  CoverLetter[]
  jobApplications JobApplication[]
  versions      ResumeVersion[]
  comments      Comment[]
  portfolioProjects PortfolioProject[]
  tenant        Tenant?        @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model ResumeSection {
  id       String            @id @default(cuid())
  resumeId String
  type     ResumeSectionType
  title    String
  position Int
  content  Json

  resume   Resume            @relation(fields: [resumeId], references: [id], onDelete: Cascade)
}

model CoverLetter {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  resumeId  String?
  title     String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id])
  resume    Resume?  @relation(fields: [resumeId], references: [id])
  jobApplications JobApplication[]
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model JobApplication {
  id            String       @id @default(cuid())
  userId        String
  tenantId      String?
  title         String
  company       String
  location      String?
  link          String?
  status        JobStatus    @default(TO_APPLY)
  appliedAt     DateTime?
  salary        String?
  notes         String?
  resumeId      String?
  coverLetterId String?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  reminderDate  DateTime?

  user          User         @relation(fields: [userId], references: [id])
  resume        Resume?      @relation(fields: [resumeId], references: [id])
  coverLetter   CoverLetter? @relation(fields: [coverLetterId], references: [id])
  tenant        Tenant?      @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Subscription {
  id                  String              @id @default(cuid())
  userId              String              @unique
  plan                SubscriptionPlan    @default(FREE)
  status              SubscriptionStatus  @default(TRIALING)
  stripeCustomerId    String?
  stripeSubscriptionId String?
  currentPeriodEnd    DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  user                User                @relation(fields: [userId], references: [id])
}

model AICallLog {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  type      String
  tokens    Int?
  createdAt DateTime @default(now())
  metadata  Json?

  user      User     @relation(fields: [userId], references: [id])
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model CareerPersona {
  id            String   @id @default(cuid())
  userId        String
  tenantId      String?
  name          String
  targetIndustry String?
  targetRoles   String[]
  summary       String?
  skillsFocus   String[]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id])
  resumes       Resume[]
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model ResumeVersion {
  id               String   @id @default(cuid())
  resumeId         String
  createdAt        DateTime @default(now())
  label            String?
  dataSnapshot     Json
  atsScoreSnapshot Int?

  resume           Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
}

model Comment {
  id          String   @id @default(cuid())
  resumeId    String
  sectionId   String?
  authorUserId String
  body        String
  createdAt   DateTime @default(now())

  resume      Resume   @relation(fields: [resumeId], references: [id], onDelete: Cascade)
  author      User     @relation(fields: [authorUserId], references: [id], onDelete: Cascade)
}

model FeatureFlag {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  key       String
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model JobSource {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  name      String
  platform  String
  searchUrl String
  filters   Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  leads     JobLead[]
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

enum JobLeadStatus {
  NEW
  REVIEWED
  ADDED_TO_TRACKER
  IGNORED
}

model JobLead {
  id          String        @id @default(cuid())
  userId      String
  tenantId    String?
  jobSourceId String?
  title       String
  company     String
  location    String?
  link        String?
  rawData     Json?
  status      JobLeadStatus @default(NEW)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  jobSource   JobSource?    @relation(fields: [jobSourceId], references: [id], onDelete: SetNull)
  tenant      Tenant?       @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

enum QuestionCategory {
  BEHAVIORAL
  TECHNICAL
  CASE
  SYSTEM_DESIGN
}

enum QuestionDifficulty {
  EASY
  MEDIUM
  HARD
}

model InterviewQuestion {
  id          String             @id @default(cuid())
  category    QuestionCategory
  roleTags    String[]
  difficulty  QuestionDifficulty
  questionText String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserInterviewSession {
  id          String   @id @default(cuid())
  userId      String
  tenantId    String?
  roleTarget  String
  sessionType String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers     UserInterviewAnswer[]
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model UserInterviewAnswer {
  id          String   @id @default(cuid())
  sessionId   String
  questionId  String?
  answerText  String
  aiFeedback  Json?
  score       Int?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  session     UserInterviewSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question    InterviewQuestion?   @relation(fields: [questionId], references: [id], onDelete: SetNull)
}

model UserStory {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  title     String
  context   String?
  task      String?
  action    String?
  result    String?
  tags      String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Portfolio {
  id          String   @id @default(cuid())
  userId      String
  tenantId    String?
  slug        String   @unique
  title       String
  headline    String?
  bio         String?
  sections    Json
  themeConfig Json
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  projects    PortfolioProject[]
  tenant      Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model PortfolioProject {
  id            String   @id @default(cuid())
  portfolioId   String
  resumeId      String?
  tenantId      String?
  title         String
  subtitle      String?
  description   String?
  role          String?
  technologies  String[]
  links         Json?
  impactMetrics Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  portfolio     Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  resume        Resume?   @relation(fields: [resumeId], references: [id], onDelete: SetNull)
  tenant        Tenant?   @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Contact {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  name      String
  roleTitle String?
  company   String?
  email     String?
  linkedinUrl String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  OutreachMessage[]
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

enum OutreachChannel {
  EMAIL
  LINKEDIN
  OTHER
}

enum OutreachStatus {
  DRAFT
  SENT
  NEEDS_REPLY
  CLOSED
}

model OutreachMessage {
  id          String          @id @default(cuid())
  userId      String
  tenantId    String?
  contactId   String?
  channel     OutreachChannel
  body        String
  subject     String?
  status      OutreachStatus  @default(DRAFT)
  sentAt      DateTime?
  followUpDate DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  contact     Contact?        @relation(fields: [contactId], references: [id], onDelete: SetNull)
  tenant      Tenant?         @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Organization {
  id        String   @id @default(cuid())
  name      String
  domain    String?
  tenantId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  memberships OrganizationMembership[]
  openings   JobOpening[]
  tenant     Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

enum OrganizationRole {
  OWNER
  ADMIN
  MEMBER
}

model OrganizationMembership {
  id              String            @id @default(cuid())
  organizationId  String
  userId          String
  tenantId        String?
  role            OrganizationRole  @default(MEMBER)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  organization    Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant          Tenant?           @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

enum JobOpeningStatus {
  OPEN
  PAUSED
  CLOSED
}

model JobOpening {
  id          String           @id @default(cuid())
  organizationId String
  tenantId    String?
  title       String
  description String
  location    String?
  status      JobOpeningStatus @default(OPEN)
  applicationFormConfig Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  submissions  CandidateSubmission[]
  tenant       Tenant?      @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

enum CandidateStatus {
  RECEIVED
  REVIEWING
  INTERVIEWING
  OFFERED
  REJECTED
}

model CandidateSubmission {
  id          String           @id @default(cuid())
  jobOpeningId String
  tenantId    String?
  candidateName String
  candidateEmail String
  resumeLink   String
  notes        String?
  status       CandidateStatus @default(RECEIVED)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  jobOpening   JobOpening @relation(fields: [jobOpeningId], references: [id], onDelete: Cascade)
  tenant       Tenant?    @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Plugin {
  id               String   @id @default(cuid())
  name             String
  description      String?
  enabledByDefault Boolean  @default(true)
  configSchema     Json?
}

model UserPluginConfig {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  pluginId  String
  enabled   Boolean  @default(true)
  config    Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  plugin    Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade)
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model WebhookEndpoint {
  id        String   @id @default(cuid())
  userId    String
  tenantId  String?
  url       String
  eventTypes String[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs      WebhookLog[]
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

enum SkillCategory {
  TECHNICAL
  SOFT
  DOMAIN
}

enum SkillProficiency {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum SkillSource {
  RESUME
  INTERVIEW
  MANUAL
  AI_INFERRED
}

model Skill {
  id        String        @id @default(cuid())
  name      String        @unique
  category  SkillCategory
  aliases   String[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  users     UserSkill[]
}

model UserSkill {
  id            String          @id @default(cuid())
  userId        String
  tenantId      String
  skillId       String
  proficiency   SkillProficiency
  confidence    Float           @default(0.6)
  source        SkillSource
  lastUpdatedAt DateTime        @default(now())

  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant        Tenant          @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  skill         Skill           @relation(fields: [skillId], references: [id], onDelete: Cascade)
}

model WebhookLog {
  id          String   @id @default(cuid())
  endpointId  String
  status      Int
  errorMessage String?
  timestamp   DateTime @default(now())

  endpoint    WebhookEndpoint @relation(fields: [endpointId], references: [id], onDelete: Cascade)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
